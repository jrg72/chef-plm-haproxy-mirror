global
  maxconn 4096
  daemon
  user haproxy
  group haproxy
  log 127.0.0.1 local0 debug
  stats socket /tmp/haproxysock user haproxy group sysadmin mode 770 level admin

defaults
  mode    http
  retries 3
  maxconn 2000
  option redispatch
  option httpclose
  option httplog
  option httpchk
  option forwardfor
  option http-pretend-keepalive
  timeout  connect 5s
  timeout  client 30s
  timeout  server 30s
  timeout  queue  60s
  log global
  balance roundrobin

frontend www-http
  bind 0.0.0.0:80
  reqadd X-Forwarded-Proto:\ http
  default_backend www-backend

frontend www-https
  bind 0.0.0.0:443 ssl crt <%= @node['haproxy']['ssl_dir'] %>/cert.pem ca-file /etc/pki/tls/certs/ca-bundle.trust.crt
  reqadd X-Forwarded-Proto:\ https
  default_backend www-backend

backend www-backend
  redirect scheme https if !{ ssl_fc }
  <% @servers.each do |server| %>
  server <%= server['name'] %> <%= server['ip'] %>:<%= server['port'] %> maxconn <%= server['maxconn'] %> weight <%= server['weight'] %>
  <% end %>
